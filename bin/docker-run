#!/bin/bash

# The concrete docker images to be run:
MONGO=mongo
AGRAPH=franzinc/agraph
ORRONT=mmisw/orr-ont:3.1.0


function run_mongo() {
	if [ "`uname`" = "Linux" ]; then
		docker run --name mongo -d \
			   -p 27017:27017 \
			   -v ${ORR_ONT_BASE_DIR}/mongo:/data/db \
			   $MONGO
	else
		echo "WARN: Not using -v for mongo as this is not a Linux box"
		docker run --name mongo -d \
			   -p 27017:27017 \
			   $MONGO
	fi
}

function run_agraph() {
	docker run --name agraph -d \
		   -v ${ORR_ONT_BASE_DIR}:/opt/orr-ont-base-directory \
		   -m 1g \
		   -p 10000-10035:10000-10035 \
		   $AGRAPH
}

function run_orront() {
    docker run --name orr-ont -d \
		   --link mongo \
		   --link agraph \
		   -e MONGO_HOST=mongo \
		   -e MONGO_PORT=27017 \
		   -e AGRAPH_HOST=agraph \
		   -e AGRAPH_PORT=10035 \
		   -v ${ORR_ONT_BASE_DIR}/orront.conf:/etc/orront.conf \
		   -v ${ORR_ONT_BASE_DIR}/orront-notifyemails:/etc/orront-notifyemails \
		   -v ${ORR_ONT_BASE_DIR}:/opt/orr-ont-base-directory \
		   -p 9090:8080 \
		   $ORRONT
}

function usage() {
	echo "Usage:"
	echo "  docker-run [ mongo | agraph | orront ]*"
	echo "  (order is important)"
	echo
	echo "Env var ORR_ONT_BASE_DIR must be defined."
	echo "If needed, edit this script to adjust the concrete images"
	echo "to be run for your ORR instance."
	echo
	echo "To launch all images:"
	echo "     docker-run mongo agraph orront"
	echo "To launch only the ORR (assuming mongo and agraph are already running):"
	echo "     docker-run orront"
	echo
}

what=$1

if [ "$what" = "" ]; then
	usage
else
	if [ "${ORR_ONT_BASE_DIR}" = "" ]; then
		echo "ERROR: env var ORR_ONT_BASE_DIR undefined"
		exit 1
	fi

	if [ ! -d "${ORR_ONT_BASE_DIR}" ]; then
		echo "ERROR: $ORR_ONT_BASE_DIR: invalid directory"
		exit 1
	fi

	echo "ORR_ONT_BASE_DIR = ${ORR_ONT_BASE_DIR}"

	args=$*
	for what in $args; do
		echo "run_$what"
		run_$what
	done
fi
